[![Scala CI](https://github.com/htrc/HTRC-MetadataService/actions/workflows/ci.yml/badge.svg)](https://github.com/htrc/HTRC-MetadataService/actions/workflows/ci.yml)
[![codecov](https://codecov.io/github/htrc/HTRC-MetadataService/branch/develop/graph/badge.svg?token=LILLTB9G4K)](https://codecov.io/github/htrc/HTRC-MetadataService)
[![GitHub release (latest SemVer including pre-releases)](https://img.shields.io/github/v/release/htrc/HTRC-MetadataService?include_prereleases&sort=semver)](https://github.com/htrc/HTRC-MetadataService/releases/latest)

# HTRC-MetadataService
A simple service for retrieving metadata for a given set of volume IDs

# Build
`sbt clean stage`
Then find the result in `target/universal/stage/`

# Deploy
Copy the folder `target/universal/stage/` to the deployment location and rename as desired (henceforth referred to as `DEPLOY_DIR`).

# Docker
You can create a Docker image with:
`sbt docker:publishLocal`

For more Docker capabilities, see: https://www.scala-sbt.org/sbt-native-packager/formats/docker.html#tasks

# Setup
1. Generate an application secret by running `sbt playGenerateSecret`
2. Set `MONGODB_URI` environment variable to point to the Mongo instance holding the metadata
3. Set `METASERVICE_SECRET` environment variable to the value generated by step 0

# Run
*Note:* You must have the environment variables set before running (or edited the `application.conf` accordingly)
```bash
$DEPLOY_DIR/bin/htrc-metadataservice -Dhttp.address=HOST -Dhttp.port=PORT -Dplay.http.context=/api
```
where `HOST` is the desired hostname or IP to bind to, and `PORT` is the desired port to run on.

# API

## Request/response format

Note: The service respects the HTTP `Accept` header.
The service can return responses in GZIP format by setting `Accept-Encoding: gzip` request header.


### Standard

#### Request

```
GET   /api/v2/metadata?ids=ID1|ID2|ID3...
POST  /api/v2/metadata
      where the body contains:
      ID1|ID2|ID3|...
      or
      ID1
      ID2
      ID3
      ...
```
Note: For the POST request, `Content-type: text/plain` must be set in the request

#### Response
```
{
  "found": {
      "hvd.32044038401683": {
        ... content of the JSON metadata file for this volume ...
      },
      "umn.31951p003004858": {
        ... content of the JSON metadata file for this volume ...
      },
      ...
  },
  "missing": [ "hvd.3204403840168x", "badid", ... ]
}
```

#### Example

`curl -v -X GET 'http://HOSTNAME:PORT/api/v2/metadata?ids=hvd.32044038401683|SOMEMISSINGID`

Returns:
```json
{
    "found": {
        "hvd.32044038401683": {
            "accessRights": "pd",
            "category": "Greek language and literature. Latin language and literature",
            "contributor": [
                {
                    "id": "http://www.viaf.org/viaf/39611820",
                    "name": "Buttmann, Ph. (Philipp), 1764-1829.",
                    "type": "http://id.loc.gov/ontologies/bibframe/Person"
                },
                {
                    "id": "http://www.viaf.org/viaf/74647197",
                    "name": "Everett, Edward, 1794-1865.",
                    "type": "http://id.loc.gov/ontologies/bibframe/Person"
                }
            ],
            "dateCreated": 20230222,
            "genre": "http://id.loc.gov/vocabulary/marcgt/doc",
            "htid": "hvd.32044038401683",
            "id": "http://hdl.handle.net/2027/hvd.32044038401683",
            "language": [
                "eng",
                "grc",
                "ger"
            ],
            "lastRightsUpdateDate": 20230115,
            "lcc": "PA258.B92 1826",
            "lccn": "10024074",
            "mainEntityOfPage": [
                "https://catalog.hathitrust.org/Record/006552339",
                "http://catalog.hathitrust.org/api/volumes/brief/oclc/4050636.json",
                "http://catalog.hathitrust.org/api/volumes/full/oclc/4050636.json"
            ],
            "oclc": "4050636",
            "pubDate": 1826,
            "pubPlace": {
                "id": "http://id.loc.gov/vocabulary/countries/mau",
                "name": "Massachusetts",
                "type": "http://id.loc.gov/ontologies/bibframe/Place"
            },
            "publisher": {
                "id": "http://catalogdata.library.illinois.edu/lod/entities/ProvisionActivityAgent/ht/Cummings,%20Hilliard%20and%20Co.",
                "name": "Cummings, Hilliard and Co.",
                "type": "http://id.loc.gov/ontologies/bibframe/Organization"
            },
            "schemaVersion": "https://schemas.hathitrust.org/EF_Schema_MetadataSubSchema_v_3.0",
            "sourceInstitution": {
                "name": "HVD",
                "type": "http://id.loc.gov/ontologies/bibframe/Organization"
            },
            "title": "Greek grammar for the use of schools /",
            "type": [
                "DataFeedItem",
                "Book"
            ],
            "typeOfResource": "http://id.loc.gov/ontologies/bibframe/Text"
        }
    },
    "missing": [
          "SOMEMISSINGID"
    ]
}
```

### Streaming

#### Request

```
GET   /api/v2/streaming?ids=ID1|ID2|ID3...
POST  /api/v2/streaming
      where the body contains:
      ID1|ID2|ID3|...
      or
      ID1
      ID2
      ID3
      ...
```

Note: For the POST request, `Content-type: text/plain` must be set in the request

#### Response

The response will come as `Content-type:text/plain` in the [JSON lines](https://jsonlines.org/) format, 
where each line represents one metadata record. Any volume IDs requested that aren't found will be ignored
(only the found ones are returned).

#### Example

`curl -v -X GET 'http://HOSTNAME:PORT/api/v2/streaming?ids=hvd.32044038401683|SOMEMISSINGID`

Returns:
```
{ ... metadata record for hvd.32044038401683 ... }
```
(note that `SOMEMISSINGID` is not flagged as missing in the response)
